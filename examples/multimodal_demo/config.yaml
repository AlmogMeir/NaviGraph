log_level: info
experiment_path: .
experiment_output_path: "{PROJECT_ROOT}/output"

# Setup configuration (used by setup commands)
setup:
  map_path: ./resources/maze_map.png
  spatial_image_for_calibration: ./demo_session/memory5-11022023_withrewardafter8min.avi
  calibration_matrix: ./resources/transform_matrix.npy

plugins:
  # Primary pose estimation data (establishes temporal index)
  - name: pose_data
    type: pose_tracking
    file_pattern: '.*DLC.*\.h5$'  # Match DeepLabCut H5 files
    config:
      bodypart: 'Nose'
      likelihood_threshold: 0.3
      bodyparts: 'all'

  # Camera calibration transformation matrix
  - name: calibration_matrix
    type: calibration
    shared: true  # Look in resources folder
    file_pattern: 'transform_matrix\.npy$'
    config: {}

  # Neural activity from calcium imaging
  - name: neural_activity
    type: neural_activity
    file_pattern: '^minian$'  # Match minian folder exactly
    config:
      merge_mode: "left"  # Merge strategy with session DataFrame
      unit_prefix: "neuron_"  # Prefix for neuron column names
      derived_metrics:
        neuron_mean_activity: 'mean'  # Calculate mean activity across all neurons
    

  # Head direction from IMU sensor
  - name: head_direction
    type: head_direction
    file_pattern: '.*headOrientation\.csv$'  # Match head orientation CSV
    config:
      yaw_offset: -167  # Calibration offset for yaw angle (degrees)
      positive_direction: -1  # Direction correction multiplier
      skip_index: 2  # Sampling rate adjustment (use every nth sample)
      merge_mode: "left"  # Merge strategy with session DataFrame

  # Spatial coordinate transformation and tile detection
  - name: map_coords
    type: map_location
    shared: true  # Map is shared across sessions
    file_pattern: '.*maze_map\.png$'  # Match maze map image
    config:
      bodyparts: ['Nose']  # Which bodyparts to track for map coordinates

  # Graph-based spatial navigation analysis
  - name: graph_coords
    type: graph_location
    shared: true  # Graph is shared across sessions
    config:
      reward_tile_id: 273  # Tile ID for reward location

graph:
  builder:
    type: binary_tree
    config:
      height: 7
  mapping_file: ./resources/graph_mapping.pkl
  conflict_strategy: node_priority

analyze:
  metrics:
    time_to_reward: 
      func_name: 'time_a_to_b'
      args: 
        a: 145
        b: 273
    
    velocity_to_reward:
      func_name: 'velocity_a_to_b'
      args:
        a: 145
        b: 273
    
    exploration_percentage:
      func_name: 'exploration_percentage'

  save_as_csv: true
  save_as_pkl: true
  save_raw_data_as_pkl: true

# Visualization configuration (used when running with visualize mode)
visualizations:
  output:
    enabled: true
    format: mp4
    fps: 30
    codec: mp4v
    
  pipeline:
    - name: bodypart_display
      type: bodyparts
      config:
        bodyparts: null  # null = all bodyparts
        colors:
          Nose: [0, 0, 255]      # Red
          Tail_base: [255, 0, 0] # Blue
        radius: 6
        show_labels: false
        likelihood_threshold: 0.8  # null = plot regardless of likelihood

    - name: map_overlay_display
      type: map_overlay
      config:
        position: 'bottom_right'
        size: 0.25
        opacity: 0.8
        
        # Bodyparts to show on map
        bodyparts: ['Nose']
        colors:
          Nose: [0, 0, 255]      # Red
        default_color: [255, 255, 255]  # White
        radius: 30
        thickness: 15
        
        # Likelihood filtering (optional)
        likelihood_threshold: 0.8  # null = no filtering, 0.5 = only show high confidence
        
        # Trajectory settings
        show_trajectory: False
        trail_length: 100
        fade_trail: False
        line_thickness: 100
        fade_to_color: [0, 0, 255]
        
    # - name: graph_structure_overlay
    #   type: graph_overlay
    #   config:
    #     # Graph display settings
    #     mode: 'side_by_side'
    #     size: 0.3
    #     opacity: 0.6
    #     position: 'top_right'
        
    #     # Default visualization settings
    #     default_node_size: 800
        
    #     # Performance settings
    #     cache_size: 20
        
    #     # Location source settings (specify which bodypart to use)
    #     node_column: 'Nose_graph_node'  # Use Nose position for node highlighting
    #     edge_column: 'Nose_graph_edge'  # Use Nose position for edge highlighting
        
    #     # Current node/edge highlighting
    #     highlight_node_size: 1200
    #     highlight_node_color: 'red'
    #     highlight_edge_width: 3.0
    #     highlight_edge_color: 'blue'
        
    - name: multimodal_info
      type: text_display
      config:
        columns: ['Nose_graph_node', 'yaw']  
        position: 'top_left'
        font_scale: 0.7
        color: [255, 255, 255]           
        background: true
        background_opacity: 0.7
        decimal_places: 0
        
        # Display formatting options
        show_column_names: true
        layout: 'vertical'
        separator: ' | '
        
    - name: neural_time_series
      type: time_series
      config:
        # Data to plot
        columns: ['neuron_1']  # Neural activity only for now
        
        # Display settings
        mode: 'overlay'  # Show plot overlaid on video
        position: 'top_right'  # Position for overlay mode
        size: 0.4  # Size factor for overlay
        opacity: 0.85  # Overlay transparency
        
        # Time series behavior
        plot_mode: 'fixed_window'  # 'fixed_window' or 'continuous'
        window_size: 200  # Show last 200 frames (~6.7 seconds at 30fps)
        
        # Y-axis range control
        y_range_mode: 'fixed'  # 'dynamic' auto-scales, 'fixed' uses y_range
        y_range: [0, 5]  # Fixed range when y_range_mode='fixed'
        # y_margin: 0.15  # 15% margin for dynamic scaling
        
        # Visual styling - ECG-style
        figure_size: [6, 3]
        dpi: 100
        background_color: 'black'
        grid_color: '#004400'
        grid_alpha: 0.3
        
        # Line styling
        colors: ['#00ff00']  # Bright green for neural activity
        line_width: 2.5
        
        # Axes and labels
        show_axes: false  # Clean ECG look without axes
        show_labels: false  # No y-axis labels for cleaner look
        show_values: true  # Show current value as text
        font_size: 12
        
        # Performance
        update_interval: 1  # Update every frame

# Expected file structure:
# demo_session/
# ├── memory5-11022023_withrewardafter8min.avi                    # Video file
# ├── memory5-11022023_withrewardafter8minDLC_...h5              # DeepLabCut keypoints
# ├── headOrientation.csv                                         # Head direction (qw,qx,qy,qz)
# └── minian/                                                     # Neural data directory
#     ├── A.zarr/                                                # Spatial footprints
#     ├── C.zarr/                                                # Calcium traces (df/f)
#     ├── S.zarr/                                                # Smoothed traces
#     └── ... (other Minian outputs)

# Notes:
# 1. This configuration demonstrates full multimodal integration
# 2. Neural activity data will be available as columns: neuron_0, neuron_1, ..., neuron_N, neuron_mean_activity
# 3. Head direction data will be available as columns: yaw, pitch, roll
# 4. All data is synchronized by frame index for temporal alignment
# 5. The session DataFrame will contain all modalities for comprehensive analysis